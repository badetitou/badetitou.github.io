<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="Benoît Verhaeghe's blog">
    

    <link rel="icon" href="/img/logo/logo.png" type="image/x-icon">


    <title>Collect users' data - Benoît Verhaeghe</title>

    <link rel="canonical" href="http://badetitou.github.io/misc/2019/10/17/EventCollect/">

    <!-- <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css"> -->
    
    <script src="https://kit.fontawesome.com/5574707d0b.js" crossorigin="anonymous"></script>
    
    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/main.css">
    <!-- My JS -->
    <script src="/js/my-head.js"></script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <link type="application/atom+xml" rel="alternate" href="http://badetitou.github.io/feed.xml" title="Benoît Verhaeghe" />

</head>


<body>

    <nav>
    <div class="nav-wrapper">
        <a href="#" onclick="openNav()" class="sidenav-trigger"><i class="material-icons">menu</i></a>
        
        <ul class="left hide-on-med-and-down"> <li>
        <a href="/" style="margin-left: 20px;"> Benoît Verhaeghe</a>
</li>
</ul>

        <ul class="right hide-on-med-and-down">
            <li>
                <span style="width: 30px; display: inline-block;">
                    <i id="theme-switch" style="font-size: 20px" class="fa-solid fa-1x"></i>
                </span>
            </li>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
            <li><a href="/teaching/">Teaching</a></li>
        
        
        
        
        
        
        
        
        
            <li><a href="/post/">Posts</a></li>
        
        
        
        
        
        
        
        
        
            <li><a href="/projects/">Projects</a></li>
        
        
        
            <li><a href="/research/">Research</a></li>
        
        
        
        
        
        </ul>
        
    </div>
</nav>

<ul class="sidenav" id="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
    <li><a href="/">Home</a></li>
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
            <li><a href="/teaching/">Teaching</a></li>
        
    
        
        
    
        
        
    
        
            <li><a href="/post/">Posts</a></li>
        
    
        
        
    
        
        
    
        
            <li><a href="/projects/">Projects</a></li>
        
    
        
            <li><a href="/research/">Research</a></li>
        
    
        
        
    
</ul>

<div id="sidenav-overlay" onclick="closeNav()"></div>

    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12">
                <div class="post-heading text-center">
                    <h1>Collect users' data</h1>
                    
                    <h2 class="subheading">I present how to collect data from users in Pharo</h2>
                    
                    <span class="meta">Posted by
                        Benoît "badetitou" Verhaeghe on
                        October 17, 2019</span>
                    <span class="post-meta">
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article class="container">
    <div class="row">
        <div class="col s12 m12">
            <div class="card">
                <div class="card-content article-content">
                    <h2 id="introduction">Introduction</h2>

<p>Few years ago, I wanted to collect data from Pharo users (see <a href="/projects/TUA/TUA">Tests Usage Analyser</a>).
I was like, <em>Hmm, how can I do that? Do we already have such tool? <img class="emoji" title=":thinking:" alt=":thinking:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png" height="20" width="20"></em>.
And <strong>YES</strong>!
We can use <code class="language-plaintext highlighter-rouge">GTEventCollector</code>.
You probably have used it already through the privacy settings.</p>

<p>In this post, I’ll explain how to set up your own data collector and how to use it.
Then, we’ll see how to extract the data.</p>

<h2 id="add-a-new-event-collector">Add a new Event Collector</h2>

<h3 id="preparation">Preparation</h3>

<p>The first step to collect data is to create a new instance of <code class="language-plaintext highlighter-rouge">GTEventCollector</code>.
It is this instance that will be used to send new data.
We can also use the subclass <code class="language-plaintext highlighter-rouge">GTEventCollector</code>.</p>

<p>Let’s create a new instance:</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">eventCollector</span> <span class="o">:=</span> <span class="nc">GTEventCollector</span> <span class="nb">new</span><span class="p">.</span>
</code></pre></div></div>

<p>Creating a collector is not enough.
It needs to be configured to be completely operational.
In particular, we need to register it in the GTRecorder.
This object has the responsibility to send the data to the server that will gather the data.</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">eventCollector</span> <span class="o">:=</span> <span class="nc">GTEventCollector</span> <span class="nb">new</span>
    <span class="nf">register</span><span class="p">.</span>
</code></pre></div></div>

<p>Once the event collector is created, we can customize it for our records.
We can change multiple properties: <code class="language-plaintext highlighter-rouge">#url:</code>, <code class="language-plaintext highlighter-rouge">#category:</code>, <code class="language-plaintext highlighter-rouge">#occupent:</code>.</p>

<ol>
  <li>
<code class="language-plaintext highlighter-rouge">#url:</code> is the server website. The default one is: <em>http://gc.dcc.uchile.cl.:8080/gt/events</em>. We may want to change it for security or privacy purpose.</li>
  <li>
<code class="language-plaintext highlighter-rouge">#category:</code> is used to group your data in a specific directory in the server. It is useful to analyse only the data of your application. In my case, I used the category <code class="language-plaintext highlighter-rouge">#testsUsageAnalyserEvents</code>.</li>
  <li>
<code class="language-plaintext highlighter-rouge">#occupent:</code> is an instance of any object. When it is removed by the GC, the recorder unregisters the collector. So, using an occupent is a good idea to keep only one instance of the recorder instead of creating a new one each time. In my case, I use an instance of <a href="https://github.com/pharo-open-documentation/pharo-wiki/blob/master/PharoProjects/Announcer.md">Announcer</a>, so the collector exists until the ‘Announce’ instance is removed from the memory.</li>
</ol>

<p>At the end, we have the following code to create a collector:</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">eventCollector</span> <span class="o">:=</span> <span class="nc">GTEventCollector</span> <span class="nb">new</span>
    <span class="nf">occupant:</span> <span class="nc">TUAAnnouncer</span> <span class="nf">uniqueInstance</span><span class="p">;</span>
    <span class="nf">category:</span> <span class="ss">#testsUsageAnalyserEvents</span><span class="p">;</span>
    <span class="nf">register</span><span class="p">;</span>
    <span class="nf">yourself</span>
</code></pre></div></div>

<h3 id="collect-data">Collect data</h3>

<p>Once the event collector is created, we can use it to record data and send them to a server.
First, we need to learn how to create a data format.
It is simple since, by default, the recorder uses <a href="https://github.com/pharo-open-documentation/pharo-wiki/blob/master/ExternalProjects/Export/JSON.md">Ston</a> as a format to send the data.
So we can use nearly everything.</p>

<p>To collect new data, we can use both <code class="language-plaintext highlighter-rouge">#add: anEvent</code> and <code class="language-plaintext highlighter-rouge">#addIfAvailable: anEvent</code>.
However, we should use the <code class="language-plaintext highlighter-rouge">#addIfAvailable:</code> because it will check users have accepted to send their data.
Unless you don’t care about privacy <img class="emoji" title=":smiling_imp:" alt=":smiling_imp:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f608.png" height="20" width="20">?</p>

<p>So, let’s add a simple data:</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">eventCollector</span> <span class="nf">addIfAvailable:</span> <span class="m">42</span>
</code></pre></div></div>

<p>In my previous work, I wanted to record more complex data.
A good way to do it is to use dictionary.
In the following, I present an example using dictionary created from an Announcement.</p>

<p>First, I created a method in TUAAnnouncement (it is a subclass of Announcement for my project) that adds my data to a dictionary.</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TUAAnnouncement</span><span class="nf">&gt;&gt;</span><span class="ss">#dataForTestUsageAnalyser</span>
    <span class="o">^</span> <span class="bp">super</span> <span class="nf">dataForTestUsageAnalyser</span>
        <span class="nf">at:</span> <span class="ss">#class</span> <span class="nf">put:</span> <span class="bp">self</span> <span class="nf">class</span> <span class="nf">name</span><span class="p">;</span>
        <span class="nf">at:</span> <span class="ss">#entity</span> <span class="nf">put:</span> <span class="nv">entity</span><span class="p">;</span> <span class="c">"this is the content of my announcement"</span>
        <span class="nf">at:</span> <span class="ss">#dataVersion</span> <span class="nf">put:</span> <span class="m">4</span> <span class="c">"this is the version of my data, so I can select the data from a specific version"</span><span class="p">;</span>
        <span class="nf">yourself</span>
</code></pre></div></div>

<p>The method is also understood by Object itself (to avoid bugs).</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Object</span><span class="nf">&gt;&gt;</span><span class="ss">#dataForTestUsageAnalyser</span>

  <span class="o">^</span> <span class="nc">Dictionary</span> <span class="nb">new</span>
</code></pre></div></div>

<p>Finally, when I want to record an announcement, I use a method <code class="language-plaintext highlighter-rouge">#recordAnnouncement:</code> that takes an announcement and records some entries in the dictionary and adds them to the collector.</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">recordAnnouncement:</span> <span class="nv">anAnnouncement</span>
    <span class="p">(</span><span class="nv">anAnnouncement</span> <span class="nf">respondsTo:</span> <span class="ss">#dataForTestUsageAnalyser</span><span class="p">)</span> <span class="nb">ifTrue:</span> <span class="p">[</span>
        <span class="p">[</span><span class="nv">eventCollector</span> <span class="nf">addIfAvailable:</span>
            <span class="p">(</span><span class="nv">anAnnouncement</span> <span class="nf">dataForTestUsageAnalyser</span> <span class="c">"get a dictionary from the announcement"</span>
                <span class="nf">at:</span> <span class="ss">#type</span> <span class="nf">put:</span> <span class="nv">anAnnouncement</span> <span class="nf">type</span><span class="p">;</span> <span class="c">"some meta data I used"</span>
                <span class="nf">at:</span> <span class="ss">#timestamps</span> <span class="nf">put:</span> <span class="nc">DateAndTime</span> <span class="nf">now</span><span class="p">;</span> <span class="c">"Useful to determine the creation date of an entry"</span>
                <span class="nf">yourself</span><span class="p">)</span> <span class="p">]</span>
                    <span class="nf">on:</span> <span class="nc">Error</span>
                    <span class="nf">do:</span> <span class="p">[</span> <span class="o">:</span><span class="nv">error</span> <span class="p">|</span> <span class="c">"blabla"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
</code></pre></div></div>

<h2 id="extract-the-data">Extract the data</h2>

<p>Once the data has been collected, we need to download them from the server.
By default, all the data can be downloaded at <a href="http://gc.dcc.uchile.cl/">http://gc.dcc.uchile.cl/</a>.
If everything goes well, we can now see your category in <code class="language-plaintext highlighter-rouge">gt/events/&lt;myCategory&gt;</code>.
In my case, we have data in <code class="language-plaintext highlighter-rouge">gt/events/testsUsageAnalyserEvents</code>
The data are sort by month.</p>

<p>To analyse the data, the first step is to open a Pharo image.
Then, we can use <code class="language-plaintext highlighter-rouge">GTEventTool</code> to unpack our data in the Pharo memory and analyse it.</p>

<p>The tool comes with methods to download and extract the data.</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GTEventTool</span> <span class="nf">default</span> <span class="nf">ensureLocalDirectory</span> <span class="c">"download the data and extract them (from the archive)"</span><span class="p">.</span>
</code></pre></div></div>

<p>When the data is downloaded, we can load it in Pharo.</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GTEventTool</span> <span class="nf">default</span> <span class="nf">unpackAll</span><span class="p">.</span> <span class="c">"unpack all the data"</span>
<span class="nc">GTEventTool</span> <span class="nf">default</span> <span class="nf">unpackAll:</span> <span class="s">'./gt/events/testsUsageAnalyserEvents'</span> <span class="nf">asFileReference</span><span class="p">.</span> <span class="c">"unpack the data in testsUsageAnalyserEvents"</span>
</code></pre></div></div>

<p>However, we already have a lot of data (~1Go).
If you want to go faster, I’ve created some helpers.</p>

<p>The method <code class="language-plaintext highlighter-rouge">unpackDirectory:</code> will do the first step of unpacking and can be executed on only one directory.</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">unpackDirectory:</span> <span class="nv">aStringPath</span>
    <span class="o">^</span> <span class="nc">GTEventUnpacking</span> <span class="nf">default</span> <span class="nf">unpackDirectory:</span> <span class="nv">aStringPath</span> <span class="nf">asFileReference</span>
</code></pre></div></div>

<p>The method <code class="language-plaintext highlighter-rouge">unpackedCollectionOfGTEvent:</code> will take a collection of GTEvent, which is the return of <code class="language-plaintext highlighter-rouge">unpackDirectory:</code> and convert each entry into the real data.</p>

<div class="language-st highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">unpackedCollectionOfGTEvent:</span> <span class="nv">aCollectionOfGTEvent</span>
    <span class="o">^</span> <span class="nv">aCollectionOfGTEvent</span> <span class="nf">flatCollect:</span> <span class="ss">#safeUnpackedData</span><span class="p">.</span>
</code></pre></div></div>

<p>We can now analyze the data.</p>

                </div>
            </div>
        </div>
    </div>

    <script src="https://utteranc.es/client.js" repo="badetitou/badetitou.github.io" issue-term="pathname" label="comments" theme="boxy-light" crossorigin="anonymous" async>
</script>

    <ul class="pager list-inline">
        
        <li class="previous">
            <a class="m-button" href="/misc/2019/09/13/OOAnalysis/" data-toggle="tooltip" data-placement="top" data-tooltip="Analyze OO project">←
                Previous Post</a>
        </li>
        
        
        <li class="next">
            <a class="m-button" href="/misc/2020/06/06/Testing-Uffi/" data-toggle="tooltip" data-placement="top" data-tooltip="Testing UFFI Binding with Travis">Next Post →</a>
        </li>
        
    </ul>
</article>


    <!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col m12">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="https://twitter.com/badetitou">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a rel="me" href="https://piaille.fr/@badetitou">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://orcid.org/0000-0002-4588-2698">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fab fa-orcid fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/badetitou">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.linkedin.com/in/benoitverhaeghe">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin-in fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="mailto:benoit@badetitou.fr">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="text-center">Copyright © badetitou 2023
                </p>
            </div>
        </div>
    </div>
</footer>

    <!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<script src="/js/my.js"></script>
<script src="/js/my-sidenav.js"></script>

<script src="/js/lightense.min.js"></script>

<script>

  // Init Lightense
  window.addEventListener("load", function() {
    Lightense("img:not(.no-lightense),.lightense", {
      background: 'rgba(0,0,0,0.05)'
    });
  }, false);

  // Example: Lazy Lightense
  document.addEventListener("DOMContentLoaded", function(e) {
    function createDom(type, cssClass) {
      var div = document.createElement(type);
      div.className = cssClass;
      return div;
    }

    var thumb = document.querySelector(".lightense-lazy");
    var original = new Image();

    // Init wrapper
    var wrap = createDom("div", "lightense-lazy-wrap");
    thumb.parentNode.insertBefore(wrap, thumb);
    wrap.appendChild(thumb);

    // Wrap thumbnail
    var thumbWrap = createDom("div", "lightense-lazy-thumb");
    thumbWrap.appendChild(thumb);
    wrap.appendChild(thumbWrap);

    // Wrap original
    var originalWrap = createDom("div", "lightense-lazy-large");
    original.src = thumb.dataset.original;
    originalWrap.appendChild(original);
    wrap.appendChild(originalWrap);

    // Load original image
    original.addEventListener(
      "load",
      function() {
        wrap.classList.add("on");
      },
      false
    );
  });
</script>


</body>

</html>
